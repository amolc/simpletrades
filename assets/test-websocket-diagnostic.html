<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Diagnostic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <h1>WebSocket Diagnostic Tool</h1>
                <div class="alert alert-info">
                    <h5>Current Issues:</h5>
                    <ul>
                        <li>Check if WebSocket Manager is loading</li>
                        <li>Verify WebSocket connection establishment</li>
                        <li>Test basic subscription functionality</li>
                    </ul>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Connection Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="statusLog" class="border rounded p-3" style="height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                            <p class="text-muted">Initializing diagnostic...</p>
                        </div>
                        <div class="mt-3">
                            <button id="testDirectConnection" class="btn btn-primary">Test Direct WebSocket</button>
                            <button id="testManager" class="btn btn-secondary">Test WebSocket Manager</button>
                            <button id="clearLog" class="btn btn-outline-secondary">Clear Log</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5>Raw WebSocket Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" id="wsUrl" class="form-control" value="ws://localhost:3000/ws/stream" placeholder="WebSocket URL">
                        </div>
                        <button id="connectRaw" class="btn btn-warning">Connect Raw WebSocket</button>
                        <button id="sendTest" class="btn btn-info" disabled>Send Test Message</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class WebSocketDiagnostic {
            constructor() {
                this.rawWs = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.log('Diagnostic initialized', 'info');
                this.checkWebSocketManager();
            }

            setupEventListeners() {
                document.getElementById('testDirectConnection').addEventListener('click', () => this.testDirectConnection());
                document.getElementById('testManager').addEventListener('click', () => this.testManager());
                document.getElementById('clearLog').addEventListener('click', () => this.clearLog());
                document.getElementById('connectRaw').addEventListener('click', () => this.connectRawWebSocket());
                document.getElementById('sendTest').addEventListener('click', () => this.sendTestMessage());
            }

            log(message, type = 'info') {
                const statusLog = document.getElementById('statusLog');
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : type === 'warning' ? 'text-warning' : 'text-info';
                
                statusLog.innerHTML += `<div class="${colorClass}"><small>[${timestamp}]</small> ${message}</div>`;
                statusLog.scrollTop = statusLog.scrollHeight;
            }

            checkWebSocketManager() {
                this.log('Checking for WebSocket Manager...', 'info');
                
                if (typeof WebSocketManager === 'undefined') {
                    this.log('WebSocketManager class not found - loading script...', 'warning');
                    this.loadWebSocketManager();
                } else {
                    this.log('WebSocketManager class found', 'success');
                }

                if (typeof window.wsManager === 'undefined') {
                    this.log('window.wsManager not initialized - creating instance...', 'warning');
                    this.createWebSocketManager();
                } else {
                    this.log('window.wsManager already exists', 'success');
                    this.log(`Connection status: ${window.wsManager.isConnected() ? 'Connected' : 'Disconnected'}`, 'info');
                }
            }

            loadWebSocketManager() {
                const script = document.createElement('script');
                script.src = '/assets/js/websocketManager.js';
                script.onload = () => {
                    this.log('WebSocketManager script loaded successfully', 'success');
                    this.createWebSocketManager();
                };
                script.onerror = () => {
                    this.log('Failed to load WebSocketManager script', 'error');
                };
                document.head.appendChild(script);
            }

            createWebSocketManager() {
                try {
                    if (typeof WebSocketManager !== 'undefined') {
                        window.wsManager = new WebSocketManager();
                        this.log('WebSocketManager instance created', 'success');
                    } else {
                        this.log('WebSocketManager class still not available', 'error');
                    }
                } catch (error) {
                    this.log(`Error creating WebSocketManager: ${error.message}`, 'error');
                }
            }

            async testDirectConnection() {
                this.log('Testing direct WebSocket connection...', 'info');
                
                try {
                    const ws = new WebSocket('ws://localhost:3000/ws/stream');
                    
                    ws.onopen = () => {
                        this.log('Direct WebSocket connected successfully', 'success');
                        ws.send(JSON.stringify({ type: 'test', message: 'Hello from diagnostic' }));
                    };
                    
                    ws.onmessage = (event) => {
                        this.log(`Received: ${event.data}`, 'success');
                    };
                    
                    ws.onerror = (error) => {
                        this.log(`WebSocket error: ${error}`, 'error');
                    };
                    
                    ws.onclose = () => {
                        this.log('Direct WebSocket connection closed', 'warning');
                    };
                    
                    setTimeout(() => ws.close(), 5000);
                } catch (error) {
                    this.log(`Direct connection failed: ${error.message}`, 'error');
                }
            }

            async testManager() {
                this.log('Testing WebSocket Manager...', 'info');
                
                if (!window.wsManager) {
                    this.log('WebSocket Manager not available', 'error');
                    return;
                }

                try {
                    this.log('Attempting to connect via WebSocketManager...', 'info');
                    await window.wsManager.connect();
                    this.log('WebSocketManager connected successfully', 'success');
                    
                    // Test subscription
                    const testSymbols = [{ symbol: 'SBIN', exchange: 'NSE' }];
                    const subscribed = window.wsManager.subscribe(testSymbols);
                    this.log(`Subscribed to ${subscribed.length} symbols: ${subscribed.map(s => s.symbol).join(', ')}`, 'success');
                    
                    // Test event listener
                    const unsubscribe = window.wsManager.on('price_update', (data) => {
                        this.log(`Price update received: ${JSON.stringify(data)}`, 'success');
                    });
                    
                    this.log('Event listener registered for price updates', 'info');
                    
                    setTimeout(() => {
                        unsubscribe();
                        this.log('Unsubscribed from price updates', 'info');
                    }, 10000);
                    
                } catch (error) {
                    this.log(`WebSocketManager test failed: ${error.message}`, 'error');
                }
            }

            connectRawWebSocket() {
                const url = document.getElementById('wsUrl').value;
                this.log(`Connecting to raw WebSocket: ${url}`, 'info');
                
                try {
                    this.rawWs = new WebSocket(url);
                    
                    this.rawWs.onopen = () => {
                        this.log('Raw WebSocket connected', 'success');
                        document.getElementById('sendTest').disabled = false;
                    };
                    
                    this.rawWs.onmessage = (event) => {
                        this.log(`Raw message: ${event.data}`, 'success');
                    };
                    
                    this.rawWs.onerror = (error) => {
                        this.log(`Raw WebSocket error: ${error}`, 'error');
                    };
                    
                    this.rawWs.onclose = () => {
                        this.log('Raw WebSocket closed', 'warning');
                        document.getElementById('sendTest').disabled = true;
                    };
                    
                } catch (error) {
                    this.log(`Raw connection failed: ${error.message}`, 'error');
                }
            }

            sendTestMessage() {
                if (this.rawWs && this.rawWs.readyState === WebSocket.OPEN) {
                    const testMessage = {
                        type: 'subscribe',
                        symbols: [{ symbol: 'SBIN', exchange: 'NSE' }]
                    };
                    this.rawWs.send(JSON.stringify(testMessage));
                    this.log('Test message sent', 'info');
                } else {
                    this.log('Raw WebSocket not connected', 'error');
                }
            }

            clearLog() {
                document.getElementById('statusLog').innerHTML = '<p class="text-muted">Log cleared</p>';
            }
        }

        // Initialize diagnostic when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.diagnostic = new WebSocketDiagnostic();
        });
    </script>
</body>
</html>