{% extends "layout.njk" %}

{% block title %}Confirm Subscription - SimpleIncome{% endblock %}

{% block content %}
<section class="py-5" style="padding-top: 100px;">
  <div class="container">
    <!-- Page Header with Shopping Cart Experience -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="checkout-header">
          <h1 class="page-title mb-2">
            <i class="fas fa-shopping-cart me-2 text-primary"></i>
            Checkout - {{ product.name }}
          </h1>
          <!-- Breadcrumb -->
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/">Home</a></li>
              <li class="breadcrumb-item"><a href="/products">Products</a></li>
              <li class="breadcrumb-item"><a href="/product/{{ product.id }}">{{ product.name }}</a></li>
              <li class="breadcrumb-item active" aria-current="page">Confirmation</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-lg">
          <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Confirm Your Subscription</h3>
          </div>
          <div class="card-body">
            <!-- User Details -->
            <div class="mb-4">
              <h5 class="text-primary mb-3">User Details</h5>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Name:</strong> <span id="userName">{{ user.fullName }}</span></p>
                  <p><strong>Email:</strong> <span id="userEmail">{{ user.email }}</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Phone:</strong> <span id="userPhone">{{ user.phoneNumber }}</span></p>
                  <p><strong>User ID:</strong> <span id="userId">{{ user.id }}</span></p>
                </div>
              </div>
            </div>

            <hr>

            <!-- Product & Plan Details -->
            <div class="mb-4">
              <h5 class="text-primary mb-3">Subscription Details</h5>
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Product:</strong> <span id="productName">{{ product.name }}</span></p>
                  <p><strong>Plan:</strong> <span id="planName">{{ plan.planName }}</span></p>
                  <p><strong>Duration:</strong> <span id="planDuration">{{ plan.numberOfDays }} days</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Amount:</strong> <span class="text-success fw-bold">Rs <span id="planAmount">{{ plan.cost }}</span></span></p>
                  <p><strong>Start Date:</strong> <span id="startDate" data-date="{{ startDate }}"></span></p>
                  <p><strong>End Date:</strong> <span id="endDate" data-date="{{ endDate }}"></span></p>
                </div>
              </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="mb-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="termsCheck" required checked style="border-color: #000;">
                <label class="form-check-label" for="termsCheck">
                  I agree to the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a>
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between mb-4">
              <button type="button" class="btn btn-primary btn-lg" id="confirmSubscriptionBtn">
                <i class="fas fa-check me-2"></i>Confirm Subscription
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                <i class="fas fa-arrow-left me-2"></i>Back
              </button>
            </div>

            <!-- Payment Information -->
            <div class="alert alert-info mb-0">
              <h6><i class="fas fa-info-circle me-2"></i>Payment Information</h6>
              <p class="mb-0">You will be redirected to complete the payment after confirming your subscription. Payment details will be provided on the next page.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const confirmBtn = document.getElementById('confirmSubscriptionBtn');
  const termsCheck = document.getElementById('termsCheck');
  const fmtISTDate = (d) => new Date(d).toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' });
  const sdEl = document.getElementById('startDate');
  const edEl = document.getElementById('endDate');
  if (sdEl && sdEl.dataset && sdEl.dataset.date) { sdEl.textContent = fmtISTDate(sdEl.dataset.date); }
  if (edEl && edEl.dataset && edEl.dataset.date) { edEl.textContent = fmtISTDate(edEl.dataset.date); }

  // Enable confirm button by default since checkbox is pre-checked
  confirmBtn.disabled = false;

  // Enable/disable confirm button based on terms acceptance
  termsCheck.addEventListener('change', function() {
    confirmBtn.disabled = !this.checked;
  });

  // Handle subscription confirmation
  confirmBtn.addEventListener('click', async function() {
    if (!termsCheck.checked) {
      alert('Please accept the terms and conditions');
      return;
    }

    // Disable button and show loading
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

    try {
      const subscriptionData = {
        userId: '{{ user.id }}',
        planId: '{{ plan.id }}',
        startDate: '{{ startDate }}',
        endDate: '{{ endDate }}',
        amount: '{{ plan.cost }}',
        status: 'active',
        paymentStatus: 'pending'
      };

      console.log('Creating subscription with data:', subscriptionData);

      const response = await fetch('/api/subscriptions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('authToken')
        },
        body: JSON.stringify(subscriptionData)
      });

      const result = await response.json();
      console.log('Subscription response:', result);

      if (response.ok && result.success) {
        // Success - redirect to payment page
        const subscriptionId = result.data.id;
        const authToken = localStorage.getItem('authToken');
        window.location.href = `/payment?subscriptionId=${subscriptionId}&authToken=${authToken}`;
      } else {
        // Error handling
        alert('Error creating subscription: ' + (result.message || 'Unknown error'));
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-check me-2"></i>Confirm Subscription';
      }
    } catch (error) {
      console.error('Error creating subscription:', error);
      alert('Network error: ' + error.message);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fas fa-check me-2"></i>Confirm Subscription';
    }
  });
});
</script>

<style>
/* Shopping Cart Checkout Header Styles */
.checkout-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 1.5rem;
  border-radius: 10px;
  border-left: 4px solid #007bff;
  margin-bottom: 1rem;
}

.page-title {
  font-size: 2rem;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
}

.page-title i {
  font-size: 1.8rem;
}

.breadcrumb {
  background: transparent;
  padding: 0;
  margin-bottom: 0;
  font-size: 0.9rem;
  margin-top: 0.5rem;
}

.breadcrumb-item + .breadcrumb-item::before {
  content: ">";
  color: #6c757d;
  font-weight: bold;
}

.breadcrumb-item a {
  color: #007bff;
  text-decoration: none;
  transition: color 0.2s ease;
  font-weight: 500;
}

.breadcrumb-item a:hover {
  color: #0056b3;
  text-decoration: underline;
}

.breadcrumb-item.active {
  color: #6c757d;
  font-weight: 500;
}

/* Card styling to match checkout experience */
.card {
  border: 1px solid #dee2e6;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.card-header {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
  border-bottom: 2px solid #0056b3;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .checkout-header {
    padding: 1rem;
  }
  
  .page-title {
    font-size: 1.5rem;
  }
  
  .page-title i {
    font-size: 1.4rem;
  }
  
  .breadcrumb {
    font-size: 0.85rem;
  }
}
</style>
{% endblock %}
