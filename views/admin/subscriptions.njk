{% extends "admin/layout.njk" %}
{% block title %}Admin Subscriptions{% endblock %}
{% block head %}
<link rel="stylesheet" href="/assets/admin/css/styles.css">
{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="mt-4 mb-3">
    <h2 class="mb-1">Subscription Management Dashboard</h2>
    <small class="text-muted">Manage customer subscriptions and plans</small>
  </div>

  <!-- Link Payment Modal -->
  <div class="modal fade" id="linkPaymentModal" tabindex="-1" aria-labelledby="linkPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="linkPaymentModalLabel">Link Payment for Subscription</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <p>Subscription ID: <strong id="paymentSubscriptionId"></strong></p>
          <p>Amount Due: <strong id="paymentAmountDue"></strong></p>
          <div id="qrcode" class="mb-3"></div>
          <p>Scan the QR code above to make the payment, or use the details below:</p>
          <div class="text-start mb-3">
            <p class="mb-1"><strong>Bank Name:</strong> Example Bank</p>
            <p class="mb-1"><strong>Account Number:</strong> 1234567890</p>
            <p class="mb-1"><strong>IFSC Code:</strong> EXAM0001234</p>
            <p class="mb-1"><strong>UPI ID:</strong> pay@examplebank</p>
          </div>
          <div class="alert alert-info" role="alert">
            After making the payment, please enter the transaction reference number below.
          </div>
          <form id="linkPaymentForm">
            <div class="mb-3">
              <label for="transactionReference" class="form-label">Transaction Reference Number</label>
              <input type="text" class="form-control" id="transactionReference" required>
            </div>
            <button type="submit" class="btn btn-primary" id="submitPaymentBtn">Submit Payment</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

  <div class="row g-3 mb-4" id="metricsRow">
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Active Subscriptions</div>
            <div class="h4 mb-0" id="metricActiveSubs">{{ pagination.total or 0 }}</div>
          </div>
          <i class="fas fa-user-check text-primary fs-3"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Monthly Revenue</div>
            <div class="h4 mb-0" id="metricMonthlyRevenue">Rs 0</div>
          </div>
          <i class="fas fa-chart-line text-success fs-3"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">New This Month</div>
            <div class="h4 mb-0" id="metricNewThisMonth">0</div>
          </div>
          <i class="fas fa-user-plus text-info fs-3"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted">Pending Renewals</div>
            <div class="h4 mb-0" id="metricPendingRenewals">0</div>
          </div>
          <i class="fas fa-clock text-warning fs-3"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Filters</h5>
    </div>
    <div class="card-body">
      <form id="filterForm" class="row g-3">
        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label" for="customerFilter">Customer</label>
          <select class="form-select" id="customerFilter">
            <option value="">All Customers</option>
          </select>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label" for="productFilter">Product</label>
          <select class="form-select" id="productFilter">
            <option value="">All Products</option>
          </select>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label" for="statusFilter">Status</label>
          <select class="form-select" id="statusFilter">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="expired">Expired</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label" for="sortBy">Sort By</label>
          <select class="form-select" id="sortBy">
            <option value="createdAt">Date Created</option>
            <option value="startDate">Start Date</option>
            <option value="customer.name">Customer Name</option>
            <option value="plan.product.name">Product</option>
            <option value="status">Status</option>
          </select>
        </div>
        <div class="col-md-12">
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Apply Filters</button>
            <button type="button" class="btn btn-secondary" id="clearFiltersBtn">Clear Filters</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Subscriptions Section -->
  <div class="card">
    <div class="card-header d-flex flex-column flex-md-row justify-content-md-between align-items-md-center gap-3">
      <h5 class="mb-0">Active Subscriptions</h5>
      <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
        <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search subscriptions..." style="min-width: 200px;">
        <button class="btn btn-primary btn-sm" id="addSubscriptionBtn"><i class="fas fa-plus me-1"></i>Start Subscription</button>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="subscriptionsTable">
          <thead>
            <tr>
              <th>Subscription ID</th>
              <th>Customer Name</th>
              <th>Product</th>
              <th>Plan Type</th>
              <th>Cost</th>
              <th>Start Date</th>
              <th>Status</th>
              <th>Payment Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="subscriptionsBody">
            {% for subscription in subscriptions %}
            <tr data-customer-id="{{ subscription.userId }}" data-product-id="{{ subscription.plan.Product.id or '' }}" data-created-at="{{ subscription.createdAt }}" data-start-date="{{ subscription.startDate }}">
              <td data-col="id">{{ subscription.id }}</td>
              <td data-col="customer">
                {% if subscription.User and subscription.User.fullName and subscription.User.fullName|lower != 'undefined' and subscription.User.fullName|lower != 'null' %}
                  {{ subscription.User.fullName }}
                {% elif subscription.User and subscription.User.email %}
                  {{ subscription.User.email }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td data-col="product">{{ subscription.plan.Product.name or 'N/A' }}</td>
              <td data-col="plan">{{ subscription.plan.planName or 'N/A' }}</td>
              <td data-col="cost">Rs {{ subscription.plan.cost or 0 }}</td>
              <td data-col="startDate">{{ subscription.startDate|date('Y-m-d') if subscription.startDate else '-' }}</td>
              <td data-col="status"><span class="badge {% if subscription.status == 'active' %}bg-success{% elif subscription.status == 'pending' %}bg-warning{% elif subscription.status == 'expired' %}bg-danger{% else %}bg-secondary{% endif %}">{{ subscription.status }}</span></td>
              <td data-col="paymentStatus"><span class="badge {% if subscription.paymentStatus == 'completed' %}bg-success{% elif subscription.paymentStatus == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">{{ subscription.paymentStatus }}</span></td>
              <td data-col="actions">
                <div class="btn-group btn-group-sm d-flex flex-column flex-sm-row" role="group">
                  <button class="btn btn-outline-primary btn-sm" data-action="view" data-id="{{ subscription.id }}">View</button>
                  {% if subscription.status == 'active' %}
                  <button class="btn btn-outline-danger btn-sm" data-action="cancel" data-id="{{ subscription.id }}">Cancel</button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="9" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading subscriptions...</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
          <!-- Pagination -->
          <nav aria-label="Subscriptions pagination" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
              <!-- Pagination will be populated by JavaScript -->
            </ul>
          </nav>
    </div>
  </div>
</div>

  <!-- Subscription Creation Modal -->
  <div class="modal fade" id="subscriptionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="subscriptionModalTitle">Start New Subscription</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="subscriptionForm">
            <input type="hidden" id="subscriptionId">
            
            <!-- Error Alert -->
            <div class="alert alert-danger d-none" id="subscriptionErrorAlert" role="alert">
              <!-- Error content will be populated by JavaScript -->
            </div>
            
            <div class="row">
              <div class="col-12 col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="customerSelect">Customer <span class="text-danger">*</span></label>
                  <select class="form-select" id="customerSelect" required>
                    <option value="">Select a customer...</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="productSelect">Product <span class="text-danger">*</span></label>
                  <select class="form-select" id="productSelect" required>
                    <option value="">Select a product...</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-12 col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="planSelect">Plan Type <span class="text-danger">*</span></label>
                  <select class="form-select" id="planSelect" required>
                    <option value="">Select a plan...</option>
                  </select>
                </div>
              </div>
              <div class="col-12 col-md-6">
                <div class="mb-3">
                  <label class="form-label" for="startDate">Start Date <span class="text-danger">*</span></label>
                  <input type="date" class="form-control" id="startDate" required>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-12">
                <div class="mb-3">
                  <label class="form-label" for="subscriptionNotes">Notes</label>
                  <textarea class="form-control" id="subscriptionNotes" rows="3" placeholder="Any additional notes..."></textarea>
                </div>
              </div>
            </div>
            
            <div class="alert alert-info d-none" id="planDetails">
              <h6>Plan Details:</h6>
              <div id="planDetailsContent"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveSubscriptionBtn">Start Subscription</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="/assets/admin/js/subscriptions-dashboard.js"></script>
{% endblock %}
